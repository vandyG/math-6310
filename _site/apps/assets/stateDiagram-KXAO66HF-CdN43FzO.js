import"./_Uint8Array-CPNtPV0k.js";import"./isSymbol-D1Vf4s0g.js";import"./_arrayMap-DQI2GUNb.js";import"./toString-pPvo2488.js";import"./toNumber-Bjr00yqN.js";import"./toInteger-Qi6pclEF.js";import"./isArrayLikeObject-CQy5-FN4.js";import"./_getTag-C4fv2peH.js";import"./_baseUniq-DuMeVp_r.js";import"./_baseIsEqual-Cdnsi4t8.js";import"./_toKey-BvVjBIlz.js";import"./memoize-D2QB0zzX.js";import"./get-Bi1nZ6vb.js";import"./_baseFlatten-BM8p5vhd.js";import"./_basePickBy-CViVNfOD.js";import"./pick-CHglt4eJ.js";import"./merge-DrdmtLTL.js";import"./_hasUnicode-CPHpt5EV.js";import"./_arrayReduce-DDpPg0Qh.js";import{t as A}from"./dagre-CUW-rZ9o.js";import"./_baseEach-CWBhny_f.js";import"./hasIn-BZo8Xaqq.js";import"./_baseProperty-CIKnF2iY.js";import"./now-CKgsywea.js";import"./min-DZ9NrTCT.js";import"./_baseMap-vZ8RB515.js";import"./isEmpty-D1b_MAwx.js";import"./_baseSet-B-t_O9-N.js";import"./sortBy-DV7a6-en.js";import"./range-Dsq9WHSI.js";import{t as G}from"./graphlib-C6T8v0kT.js";import"./preload-helper-CxnU7XTI.js";import"./marked.esm-BVjBUuHx.js";import"./timer-m_pEB4Lb.js";import{u as H}from"./src--EmJf_Ct.js";import"./path-Gc-fQZTe.js";import"./math-BsaXoFIn.js";import"./array-DZFD9yN1.js";import{_ as O}from"./step-aJ-oEw6-.js";import{t as P}from"./line-1VYCafWO.js";import{g as R}from"./chunk-S3R3BYOJ-DO68jEIo.js";import{n as u,r as k}from"./src-CWnjMQt8.js";import{E as U,b as t,c as C,s as v}from"./chunk-ABZYJK2D-DjRcbxmx.js";import"./chunk-7GE3RBXV-DqGwDDxD.js";import"./chunk-CVBHYZKI-Bv-w4YHJ.js";import"./chunk-QYVHNE3D-DA_jYaIp.js";import"./dist-D2dAPhhG.js";import"./chunk-JA3XYJ7Z-Mvfz9vG6.js";import"./chunk-CXMOBAN2-GhUPxuLT.js";import"./chunk-3AY6CYHV-BFFUJATX.js";import"./chunk-6OXUPJBA-Clo7-gS4.js";import"./chunk-55IACEB6-DPnl5ir_.js";import"./chunk-QN33PNHL-dhs223oU.js";import{i as I,n as W,t as M}from"./chunk-TVAH2DTR-j2EljfwG.js";var _=u(e=>e.append("circle").attr("class","start-state").attr("r",t().state.sizeUnit).attr("cx",t().state.padding+t().state.sizeUnit).attr("cy",t().state.padding+t().state.sizeUnit),"drawStartState"),F=u(e=>e.append("line").style("stroke","grey").style("stroke-dasharray","3").attr("x1",t().state.textHeight).attr("class","divider").attr("x2",t().state.textHeight*2).attr("y1",0).attr("y2",0),"drawDivider"),J=u((e,i)=>{let p=e.append("text").attr("x",2*t().state.padding).attr("y",t().state.textHeight+2*t().state.padding).attr("font-size",t().state.fontSize).attr("class","state-title").text(i.id),o=p.node().getBBox();return e.insert("rect",":first-child").attr("x",t().state.padding).attr("y",t().state.padding).attr("width",o.width+2*t().state.padding).attr("height",o.height+2*t().state.padding).attr("rx",t().state.radius),p},"drawSimpleState"),j=u((e,i)=>{let p=u(function(s,m,B){let w=s.append("tspan").attr("x",2*t().state.padding).text(m);B||w.attr("dy",t().state.textHeight)},"addTspan"),o=e.append("text").attr("x",2*t().state.padding).attr("y",t().state.textHeight+1.3*t().state.padding).attr("font-size",t().state.fontSize).attr("class","state-title").text(i.descriptions[0]).node().getBBox(),d=o.height,h=e.append("text").attr("x",t().state.padding).attr("y",d+t().state.padding*.4+t().state.dividerMargin+t().state.textHeight).attr("class","state-description"),c=!0,a=!0;i.descriptions.forEach(function(s){c||(p(h,s,a),a=!1),c=!1});let n=e.append("line").attr("x1",t().state.padding).attr("y1",t().state.padding+d+t().state.dividerMargin/2).attr("y2",t().state.padding+d+t().state.dividerMargin/2).attr("class","descr-divider"),x=h.node().getBBox(),l=Math.max(x.width,o.width);return n.attr("x2",l+3*t().state.padding),e.insert("rect",":first-child").attr("x",t().state.padding).attr("y",t().state.padding).attr("width",l+2*t().state.padding).attr("height",x.height+d+2*t().state.padding).attr("rx",t().state.radius),e},"drawDescrState"),Y=u((e,i,p)=>{let o=t().state.padding,d=2*t().state.padding,h=e.node().getBBox(),c=h.width,a=h.x,n=e.append("text").attr("x",0).attr("y",t().state.titleShift).attr("font-size",t().state.fontSize).attr("class","state-title").text(i.id),x=n.node().getBBox().width+d,l=Math.max(x,c);l===c&&(l+=d);let s,m=e.node().getBBox();i.doc,s=a-o,x>c&&(s=(c-l)/2+o),Math.abs(a-m.x)<o&&x>c&&(s=a-(x-c)/2);let B=1-t().state.textHeight;return e.insert("rect",":first-child").attr("x",s).attr("y",B).attr("class",p?"alt-composit":"composit").attr("width",l).attr("height",m.height+t().state.textHeight+t().state.titleShift+1).attr("rx","0"),n.attr("x",s+o),x<=c&&n.attr("x",a+(l-d)/2-x/2+o),e.insert("rect",":first-child").attr("x",s).attr("y",t().state.titleShift-t().state.textHeight-t().state.padding).attr("width",l).attr("height",t().state.textHeight*3).attr("rx",t().state.radius),e.insert("rect",":first-child").attr("x",s).attr("y",t().state.titleShift-t().state.textHeight-t().state.padding).attr("width",l).attr("height",m.height+3+2*t().state.textHeight).attr("rx",t().state.radius),e},"addTitleAndBox"),$=u(e=>(e.append("circle").attr("class","end-state-outer").attr("r",t().state.sizeUnit+t().state.miniPadding).attr("cx",t().state.padding+t().state.sizeUnit+t().state.miniPadding).attr("cy",t().state.padding+t().state.sizeUnit+t().state.miniPadding),e.append("circle").attr("class","end-state-inner").attr("r",t().state.sizeUnit).attr("cx",t().state.padding+t().state.sizeUnit+2).attr("cy",t().state.padding+t().state.sizeUnit+2)),"drawEndState"),X=u((e,i)=>{let p=t().state.forkWidth,o=t().state.forkHeight;if(i.parentId){let d=p;p=o,o=d}return e.append("rect").style("stroke","black").style("fill","black").attr("width",p).attr("height",o).attr("x",t().state.padding).attr("y",t().state.padding)},"drawForkJoinState"),q=u((e,i,p,o)=>{let d=0,h=o.append("text");h.style("text-anchor","start"),h.attr("class","noteText");let c=e.replace(/\r\n/g,"<br/>");c=c.replace(/\n/g,"<br/>");let a=c.split(v.lineBreakRegex),n=1.25*t().state.noteMargin;for(let x of a){let l=x.trim();if(l.length>0){let s=h.append("tspan");if(s.text(l),n===0){let m=s.node().getBBox();n+=m.height}d+=n,s.attr("x",i+t().state.noteMargin),s.attr("y",p+d+1.25*t().state.noteMargin)}}return{textWidth:h.node().getBBox().width,textHeight:d}},"_drawLongText"),Z=u((e,i)=>{i.attr("class","state-note");let p=i.append("rect").attr("x",0).attr("y",t().state.padding),o=i.append("g"),{textWidth:d,textHeight:h}=q(e,0,0,o);return p.attr("height",h+2*t().state.noteMargin),p.attr("width",d+t().state.noteMargin*2),p},"drawNote"),T=u(function(e,i){let p=i.id,o={id:p,label:i.id,width:0,height:0},d=e.append("g").attr("id",p).attr("class","stateGroup");i.type==="start"&&_(d),i.type==="end"&&$(d),(i.type==="fork"||i.type==="join")&&X(d,i),i.type==="note"&&Z(i.note.text,d),i.type==="divider"&&F(d),i.type==="default"&&i.descriptions.length===0&&J(d,i),i.type==="default"&&i.descriptions.length>0&&j(d,i);let h=d.node().getBBox();return o.width=h.width+2*t().state.padding,o.height=h.height+2*t().state.padding,o},"drawState"),D=0,K=u(function(e,i,p){let o=u(function(n){switch(n){case M.relationType.AGGREGATION:return"aggregation";case M.relationType.EXTENSION:return"extension";case M.relationType.COMPOSITION:return"composition";case M.relationType.DEPENDENCY:return"dependency"}},"getRelationType");i.points=i.points.filter(n=>!Number.isNaN(n.y));let d=i.points,h=P().x(function(n){return n.x}).y(function(n){return n.y}).curve(O),c=e.append("path").attr("d",h(d)).attr("id","edge"+D).attr("class","transition"),a="";if(t().state.arrowMarkerAbsolute&&(a=U(!0)),c.attr("marker-end","url("+a+"#"+o(M.relationType.DEPENDENCY)+"End)"),p.title!==void 0){let n=e.append("g").attr("class","stateLabel"),{x,y:l}=R.calcLabelPosition(i.points),s=v.getRows(p.title),m=0,B=[],w=0,N=0;for(let f=0;f<=s.length;f++){let g=n.append("text").attr("text-anchor","middle").text(s[f]).attr("x",x).attr("y",l+m),y=g.node().getBBox();w=Math.max(w,y.width),N=Math.min(N,y.x),k.info(y.x,x,l+m),m===0&&(m=g.node().getBBox().height,k.info("Title height",m,l)),B.push(g)}let E=m*s.length;if(s.length>1){let f=(s.length-1)*m*.5;B.forEach((g,y)=>g.attr("y",l+y*m-f)),E=m*s.length}let r=n.node().getBBox();n.insert("rect",":first-child").attr("class","box").attr("x",x-w/2-t().state.padding/2).attr("y",l-E/2-t().state.padding/2-3.5).attr("width",w+t().state.padding).attr("height",E+t().state.padding),k.info(r)}D++},"drawEdge"),b,z={},Q=u(function(){},"setConf"),V=u(function(e){e.append("defs").append("marker").attr("id","dependencyEnd").attr("refX",19).attr("refY",7).attr("markerWidth",20).attr("markerHeight",28).attr("orient","auto").append("path").attr("d","M 19,7 L9,13 L14,7 L9,1 Z")},"insertMarkers"),tt=u(function(e,i,p,o){b=t().state;let d=t().securityLevel,h;d==="sandbox"&&(h=H("#i"+i));let c=H(d==="sandbox"?h.nodes()[0].contentDocument.body:"body"),a=d==="sandbox"?h.nodes()[0].contentDocument:document;k.debug("Rendering diagram "+e);let n=c.select(`[id='${i}']`);V(n);let x=o.db.getRootDoc();L(x,n,void 0,!1,c,a,o);let l=b.padding,s=n.node().getBBox(),m=s.width+l*2,B=s.height+l*2,w=m*1.75;C(n,B,w,b.useMaxWidth),n.attr("viewBox",`${s.x-b.padding}  ${s.y-b.padding} `+m+" "+B)},"draw"),et=u(e=>e?e.length*b.fontSizeFactor:1,"getLabelWidth"),L=u((e,i,p,o,d,h,c)=>{let a=new G({compound:!0,multigraph:!0}),n,x=!0;for(n=0;n<e.length;n++)if(e[n].stmt==="relation"){x=!1;break}p?a.setGraph({rankdir:"LR",multigraph:!0,compound:!0,ranker:"tight-tree",ranksep:x?1:b.edgeLengthFactor,nodeSep:x?1:50,isMultiGraph:!0}):a.setGraph({rankdir:"TB",multigraph:!0,compound:!0,ranksep:x?1:b.edgeLengthFactor,nodeSep:x?1:50,ranker:"tight-tree",isMultiGraph:!0}),a.setDefaultEdgeLabel(function(){return{}});let l=c.db.getStates(),s=c.db.getRelations(),m=Object.keys(l);for(let r of m){let f=l[r];p&&(f.parentId=p);let g;if(f.doc){let y=i.append("g").attr("id",f.id).attr("class","stateGroup");g=L(f.doc,y,f.id,!o,d,h,c);{y=Y(y,f,o);let S=y.node().getBBox();g.width=S.width,g.height=S.height+b.padding/2,z[f.id]={y:b.compositTitleSize}}}else g=T(i,f,a);if(f.note){let y={descriptions:[],id:f.id+"-note",note:f.note,type:"note"},S=T(i,y,a);f.note.position==="left of"?(a.setNode(g.id+"-note",S),a.setNode(g.id,g)):(a.setNode(g.id,g),a.setNode(g.id+"-note",S)),a.setParent(g.id,g.id+"-group"),a.setParent(g.id+"-note",g.id+"-group")}else a.setNode(g.id,g)}k.debug("Count=",a.nodeCount(),a);let B=0;s.forEach(function(r){B++,k.debug("Setting edge",r),a.setEdge(r.id1,r.id2,{relation:r,width:et(r.title),height:b.labelHeight*v.getRows(r.title).length,labelpos:"c"},"id"+B)}),A(a),k.debug("Graph after layout",a.nodes());let w=i.node();a.nodes().forEach(function(r){r!==void 0&&a.node(r)!==void 0?(k.warn("Node "+r+": "+JSON.stringify(a.node(r))),d.select("#"+w.id+" #"+r).attr("transform","translate("+(a.node(r).x-a.node(r).width/2)+","+(a.node(r).y+(z[r]?z[r].y:0)-a.node(r).height/2)+" )"),d.select("#"+w.id+" #"+r).attr("data-x-shift",a.node(r).x-a.node(r).width/2),h.querySelectorAll("#"+w.id+" #"+r+" .divider").forEach(f=>{let g=f.parentElement,y=0,S=0;g&&(g.parentElement&&(y=g.parentElement.getBBox().width),S=parseInt(g.getAttribute("data-x-shift"),10),Number.isNaN(S)&&(S=0)),f.setAttribute("x1",0-S+8),f.setAttribute("x2",y-S-8)})):k.debug("No Node "+r+": "+JSON.stringify(a.node(r)))});let N=w.getBBox();a.edges().forEach(function(r){r!==void 0&&a.edge(r)!==void 0&&(k.debug("Edge "+r.v+" -> "+r.w+": "+JSON.stringify(a.edge(r))),K(i,a.edge(r),a.edge(r).relation))}),N=w.getBBox();let E={id:p||"root",label:p||"root",width:0,height:0};return E.width=N.width+2*b.padding,E.height=N.height+2*b.padding,k.debug("Doc rendered",E,a),E},"renderDoc"),at={parser:W,get db(){return new M(1)},renderer:{setConf:Q,draw:tt},styles:I,init:u(e=>{e.state||(e.state={}),e.state.arrowMarkerAbsolute=e.arrowMarkerAbsolute},"init")};export{at as diagram};
